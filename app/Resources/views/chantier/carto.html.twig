{# app/Resources/views/chantier/carto.html.twig #}

{% extends 'demo.html.twig' %}

{% block stylesheets %}
            <link rel="stylesheet" href="{{ asset('libs/leaflet/leaflet.css') }}" />
            <link rel="stylesheet" href="{{ asset('libs/Leaflet.markercluster/dist/MarkerCluster.css') }}" />
            <link rel="stylesheet" href="{{ asset('libs/Leaflet.markercluster/dist/MarkerCluster.Default.css') }}" />
{% endblock %}
{% block headerscripts %}
            <script src="{{ asset('libs/leaflet/leaflet.js') }}"></script>
            <script src="{{ asset('libs/Leaflet.markercluster/dist/leaflet.markercluster.js') }}"></script>
{% endblock %}


{% block body %}
                <div class="one whole padded container centered">
                    <div class="noicon" id="map" style="height:640px;"></div>
                    <script>

                            var markers = L.markerClusterGroup();

                            var mapboxUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={{ mapbox_token }}';
                            var mapboxAttribution = 'Map data <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>';

                            var outdoor = L.tileLayer(mapboxUrl, {id: 'mapbox.outdoors', accessToken: '{{ mapbox_token }}', attribution: mapboxAttribution, maxZoom: 19}),
                                grayscale = L.tileLayer(mapboxUrl, {id: 'mapbox.light', accessToken: '{{ mapbox_token }}', attribution: mapboxAttribution, maxZoom: 19}),
                                satellite = L.tileLayer(mapboxUrl, {id: 'mapbox.satellite', accessToken: '{{ mapbox_token }}', attribution: mapboxAttribution, maxZoom: 19}),
                                streets   = L.tileLayer(mapboxUrl, {id: 'mapbox.streets', accessToken: '{{ mapbox_token }}', attribution: mapboxAttribution, maxZoom: 19});

                            var baseMaps = {
                                "courbes de niveau": outdoor,
                                "plan": streets,
                                "échelle de gris": grayscale,
                                "vue satellite": satellite
                            };                               

                            var map = L.map('map', {center: [46.75, 3.10], zoom: 6, layers: [streets]});
            
                            L.control.scale().addTo(map);

                            L.control.layers(baseMaps).addTo(map);

                            var craneIcon = L.icon({
                                iconUrl: "{{ asset('img/marker.png') }}",
                                shadowUrl: "{{ asset('img/shadow_marker.png') }}",

                                iconSize:     [32, 32], // size of the icon
                                shadowSize:   [32, 32], // size of the shadow
                                iconAnchor:   [16, 32], // point of the icon which will correspond to marker's location
                                shadowAnchor: [16, 32],  // the same for the shadow
                                popupAnchor:  [-8, -32] // point from which the popup should open relative to the iconAnchor
                            });

                            function onLocationFound(e) {
                                var radius = e.accuracy / 2;

                                //L.marker(e.latlng).addTo(map).bindPopup("Vous êtes localisé à " + radius + "mètres de ce point.").openPopup();
                                //L.circle(e.latlng, radius).addTo(map);
                                map.setZoom(14);
                            }

                            function onLocationError(e) {
                                alert(e.message);
                                map.setView([46.75, 3.10], 6);  // position par défaut
                            }

                            function mapmoved() {
                                var east = map.getBounds().getEast();
                                var west = map.getBounds().getWest();
                                var north = map.getBounds().getNorth();
                                var south = map.getBounds().getSouth();  
                                var url = '{{ path('get_neighborhood') }}?east=' + east + '&west=' + west + '&south=' + south + '&north=' + north;

                                $.ajax({  

                                    url:        url ,  
                                    type:       'GET',   
                                    dataType:   'json',  
                                    async:      true,  
                                    
                                    success: function(data, status) {  
                                        markers.clearLayers();
                                        for(i = 0; i < data.length; i++) {  
                                            chantier = data[i];
                                            adresse = chantier['adresse'];
                                            markers.addLayer(L.marker([ adresse['lat'], adresse['lon']], {icon: craneIcon})
                                                            .bindPopup('<a href="lab/chantier/' + chantier['slug'] + '"><b>' + chantier['nom'] + '</b></a><br> situé ' + adresse['rue'] + ' à ' + adresse['ville'])
                                                            );
                                        }  
                                        map.addLayer(markers);
                                    },  
                                    error : function(xhr, textStatus, errorThrown) {  
                                        console.log('erreur Ajax :' + textStatus);  
                                    }  
                                });  

                            }
{# 
                            map.on('locationfound', onLocationFound);
                            map.on('locationerror', onLocationError);
 
                            map.locate({setView: true, maxZoom: 6}); 
#}
                            map.on('moveend', mapmoved);

                            mapmoved();
                    </script>
                </div>
{% endblock  %}
